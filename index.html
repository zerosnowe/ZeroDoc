<!DOCTYPE html>
<html lang="zh-CN" class="mdui-theme-light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeFrpTPCA</title>
    
    <!-- MDUI V2 CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/mdui@2.0.3/mdui.css">
    <script src="https://unpkg.com/mdui@2.0.3/mdui.global.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <!-- Markdown & Syntax Highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>

    <style>
        :root { --mdui-color-primary: #0061a4; }
        body { display: flex; height: 100vh; margin: 0; padding: 0; overflow: hidden; background-color: var(--mdui-color-surface-container-low); }
        
        mdui-navigation-drawer { 
            --mdui-navigation-drawer-width: 320px; 
            background-color: var(--mdui-color-surface-container); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
        }

        .drawer-header { padding: 16px; flex-shrink: 0; background-color: var(--mdui-color-surface-container); z-index: 2; }
        .tree-container { flex-grow: 1; overflow-y: auto; padding: 0 12px 24px 12px; scrollbar-width: thin; }
        
        .tree-item { 
            border-radius: 100px; 
            margin-bottom: 4px; 
            cursor: pointer; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --mdui-list-item-padding-left: 16px;
        }

        .file-node[active] {
            --mdui-list-item-background-color: var(--mdui-color-secondary-container) !important;
            --mdui-color-on-surface: var(--mdui-color-on-secondary-container) !important;
            font-weight: 500;
        }

        .file-node[active] mdui-icon {
            color: var(--mdui-color-primary) !important;
        }

        .tree-item:hover:not([active]) {
            --mdui-list-item-background-color: var(--mdui-color-surface-container-high);
        }

        .tree-folder-children { padding-left: 16px; border-left: 1px solid var(--mdui-color-outline-variant); margin-left: 20px; }
        
        .main-wrapper { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }
        main { flex-grow: 1; overflow-y: auto; padding: 24px; scroll-behavior: smooth; }
        .content-card { background-color: var(--mdui-color-surface); border-radius: 24px; padding: 40px; max-width: 960px; margin: 0 auto 40px auto; box-shadow: var(--mdui-elevation-level1); min-height: calc(100vh - 160px); }
        
        .prose h1 { font-size: 2.2rem; font-weight: 700; margin-bottom: 1.5rem; border-bottom: 1px solid var(--mdui-color-outline-variant); padding-bottom: 10px; }
        .prose p { line-height: 1.8; margin-bottom: 1.2rem; font-size: 1.05rem; }
        .prose pre { background: #1e1e1e; padding: 18px; border-radius: 12px; overflow-x: auto; margin: 20px 0; }
        .prose table { width: 100%; border-collapse: collapse; margin: 24px 0; overflow-x: auto; display: block; border-radius: 8px; }
        .prose th, .prose td { border: 1px solid var(--mdui-color-outline-variant); padding: 12px 16px; text-align: left; }
        .prose th { background-color: var(--mdui-color-surface-container-high); font-weight: 600; }

        #loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; }
        .hidden { display: none !important; }
        .empty-view { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 400px; opacity: 0.8; }
    </style>
</head>
<body>

    <mdui-navigation-drawer id="drawer" open close-on-overlay-click>
        <div class="drawer-header">
            <div class="flex items-center mb-2">
                <mdui-icon name="account_tree" class="mr-2 text-primary"></mdui-icon>
                <span class="text-xl font-medium">资源浏览 (智能链路)</span>
            </div>
            <mdui-divider></mdui-divider>
        </div>
        
        <div id="fileTree" class="tree-container"></div>
    </mdui-navigation-drawer>

    <div class="main-wrapper">
        <mdui-top-app-bar variant="center-aligned">
            <mdui-button-icon icon="menu" id="menuBtn"></mdui-button-icon>
            <mdui-top-app-bar-title id="appTitle">MeFrpTPCA</mdui-top-app-bar-title>
            <mdui-button-icon icon="refresh" id="refreshBtn"></mdui-button-icon>
            <mdui-button-icon icon="light_mode" id="themeBtn"></mdui-button-icon>
        </mdui-top-app-bar>

        <main id="mainScroll">
            <div id="loader" class="hidden"><mdui-circular-progress></mdui-circular-progress></div>
            <div class="content-card prose" id="markdownContent">
                <div class="empty-view">
                    <mdui-icon name="cloud_download" style="font-size: 80px;"></mdui-icon>
                    <p class="mt-4 text-lg" id="loadingText">加载中...</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        /**---------------------------------------------------------------------*/
         //* 仓库基础配置 (恢复您之前代码中的设置)
        // */
        const REPO_OWNER = "//GitHub用户名";
        const REPO_NAME = "//GitHub仓库名";
        const BRANCH = "//Github仓库分支名"; // 通常是 "main" 或 "master"
        // 如果是公开仓库且请求频率不高，可以留空。如果无法加载请填写 Token
        const GITHUB_TOKEN = ""; 
        //----------------------------------------------------------------------*/

        /**
         * 链路配置
         */
        let IS_MAINLAND = false;
        
        // 动态生成的 API 列表
        let apiQueue = [];
        
        const contentCache = new Map();
        const fileTreeContainer = document.getElementById('fileTree');
        const markdownContent = document.getElementById('markdownContent');
        const loader = document.getElementById('loader');
        const drawer = document.getElementById('drawer');
        const appTitle = document.getElementById('appTitle');
        const loadingText = document.getElementById('loadingText');

        marked.setOptions({ breaks: true, gfm: true, headerIds: true });

        window.onload = async () => {
            await checkNetworkLocation();
            initApiQueue();
            fetchRepoTree();
            
            document.getElementById('menuBtn').onclick = () => drawer.open = !drawer.open;
            document.getElementById('refreshBtn').onclick = () => {
                localStorage.removeItem('last_path');
                contentCache.clear();
                fetchRepoTree();
            };
            document.getElementById('themeBtn').onclick = () => {
                const isDark = document.documentElement.classList.toggle('mdui-theme-dark');
                document.documentElement.classList.toggle('mdui-theme-light', !isDark);
                document.getElementById('themeBtn').icon = isDark ? "light_mode" : "dark_mode";
            };
        };

        // 探测用户是否在中国大陆
        async function checkNetworkLocation() {
            try {
                const res = await fetch('https://api.myip.la/json');
                const data = await res.json();
                IS_MAINLAND = data.location && data.location.includes("China");
                console.log("Network Location:", data.location, "IS_MAINLAND:", IS_MAINLAND);
            } catch (e) {
                console.warn("Location detection failed, defaulting to Mainland mode.");
                IS_MAINLAND = true; // 失败则默认保守策略，使用镜像
            }
        }

        function initApiQueue() {
            const officialApi = `https://api.github.com`;
            const kkMirror = `https://api.kkgithub.com/repos/${REPO_OWNER}/${REPO_NAME}/git/trees/${BRANCH}?recursive=1`;
            const proxyMirror = `https://gh-proxy.com/https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/git/trees/${BRANCH}?recursive=1`;

            if (IS_MAINLAND) {
                apiQueue = [kkMirror, proxyMirror, officialApi];
                loadingText.innerText = "正在使用大陆镜像加速...";
            } else {
                apiQueue = [officialApi, kkMirror, proxyMirror];
                loadingText.innerText = "正在连接 GitHub API...";
            }
        }

        async function fetchFile(path) {
            if (contentCache.has(path)) return contentCache.get(path);
            
            // 构建获取链路：非大陆优先尝试 Raw，大陆优先尝试 jsDelivr
            const links = IS_MAINLAND 
                ? [`https://fastly.jsdelivr.net/gh/${REPO_OWNER}/${REPO_NAME}@${BRANCH}/${path}`, `https://raw.kkgithub.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${path}`]
                : [`https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${path}`, `https://fastly.jsdelivr.net/gh/${REPO_OWNER}/${REPO_NAME}@${BRANCH}/${path}`];

            for (let link of links) {
                try {
                    const res = await fetch(link);
                    if (res.ok) {
                        const text = await res.text();
                        contentCache.set(path, text);
                        return text;
                    }
                } catch (e) {}
            }
            throw new Error("所有内容获取链路均失败");
        }

        async function fetchRepoTree() {
            showLoader(true);
            let lastError = "";
            const headers = { "Accept": "application/vnd.github.v3+json" };
            if (GITHUB_TOKEN) headers["Authorization"] = `token ${GITHUB_TOKEN}`;

            for (const url of apiQueue) {
                try {
                    const res = await fetch(url, { headers });
                    if (!res.ok) continue;
                    const data = await res.json();
                    if (data.tree) {
                        const items = data.tree.filter(i => i.path.toLowerCase().endsWith('.md') || i.type === 'tree');
                        renderFileTree(items);
                        const last = localStorage.getItem('last_path');
                        if (last) loadFileContent(last);
                        else {
                            const readme = items.find(i => i.path.toLowerCase() === 'readme.md');
                            if (readme) loadFileContent(readme.path);
                        }
                        showLoader(false);
                        return;
                    }
                } catch (err) {
                    lastError = err.message;
                }
            }
            
            renderError(`初始化失败。请检查网络或稍后重试。${lastError}`);
            showLoader(false);
        }

        function renderFileTree(items) {
            const tree = {};
            items.forEach(item => {
                const parts = item.path.split('/');
                let cur = tree;
                parts.forEach((p, i) => {
                    if (i === parts.length - 1) cur[p] = item;
                    else {
                        if (!cur[p]) cur[p] = { _isDir: true, _children: {} };
                        cur = cur[p]._children;
                    }
                });
            });
            fileTreeContainer.innerHTML = '';
            buildTreeUI(tree, fileTreeContainer);
        }

        function buildTreeUI(nodes, container) {
            const keys = Object.keys(nodes).sort((a, b) => {
                const lowA = a.toLowerCase();
                const lowB = b.toLowerCase();
                if (lowA === 'readme.md') return -1;
                if (lowB === 'readme.md') return 1;
                const isDirA = nodes[a]._isDir || nodes[a].type === 'tree';
                const isDirB = nodes[b]._isDir || nodes[b].type === 'tree';
                if (isDirA && !isDirB) return -1;
                if (!isDirA && isDirB) return 1;
                return lowA.localeCompare(lowB);
            });

            keys.forEach(key => {
                const node = nodes[key];
                if (node._isDir || node.type === 'tree') {
                    const group = document.createElement('div');
                    group.innerHTML = `<mdui-list-item class="tree-item" icon="folder_open" end-icon="keyboard_arrow_down">${key}</mdui-list-item><div class="tree-folder-children"></div>`;
                    const header = group.querySelector('mdui-list-item');
                    const children = group.querySelector('.tree-folder-children');
                    header.onclick = () => {
                        const isHidden = children.classList.toggle('hidden');
                        header.endIcon = isHidden ? "keyboard_arrow_right" : "keyboard_arrow_down";
                        header.icon = isHidden ? "folder" : "folder_open";
                    };
                    container.appendChild(group);
                    buildTreeUI(node._children || {}, children);
                } else {
                    const item = document.createElement('mdui-list-item');
                    item.className = "tree-item file-node";
                    item.dataset.path = node.path;
                    item.innerHTML = `<mdui-icon slot="icon" name="description--outlined"></mdui-icon>${key.replace(/\.md$/i, '')}`;
                    item.onclick = () => loadFileContent(node.path);
                    container.appendChild(item);
                }
            });
        }

        async function loadFileContent(path) {
            showLoader(true);
            try {
                const text = await fetchFile(path);
                markdownContent.innerHTML = marked.parse(text);
                appTitle.innerText = path.split('/').pop().replace(/\.md$/i, '');
                localStorage.setItem('last_path', path);
                
                requestAnimationFrame(() => {
                    document.querySelectorAll('.file-node').forEach(el => {
                        if (el.dataset.path === path) el.setAttribute('active', '');
                        else el.removeAttribute('active');
                    });
                });

                requestAnimationFrame(() => { Prism.highlightAllUnder(markdownContent); });
                document.getElementById('mainScroll').scrollTop = 0;
                if (window.innerWidth < 1024) drawer.open = false;
            } catch (err) { 
                mdui.snackbar({ message: `读取异常: ${err.message}` }); 
            } finally { 
                showLoader(false); 
            }
        }

        function showLoader(s) { loader.classList.toggle('hidden', !s); markdownContent.style.opacity = s ? "0.3" : "1"; }
        function renderError(m) { markdownContent.innerHTML = `<div class="empty-view"><mdui-icon name="warning" color="error"></mdui-icon><p class="mt-4 p-4 text-center">${m}</p><mdui-button onclick="location.reload()">手动重试</mdui-button></div>`; }
    </script>
</body>
</html>